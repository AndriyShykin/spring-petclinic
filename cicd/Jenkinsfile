pipeline {
  agent none
  environment {
    AGENT_IMAGE = 'shykin/alpine:784426e57ac29a553b7f72717dd7bff9becbaae9'
    APP_NAME = 'spring-petclinic'
    AWS_ACCOUNT_ID = "${AWS_ACCOUNT_ID_}"
    AWS_REGION = 'eu-north-1'
    IMAGE_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    JENKINS_AWS_ROLE = 'arn:aws:iam::975049956464:role/JenkinsAssumeRole'
  }
  options {
    disableConcurrentBuilds()
    preserveStashes()
  }
  parameters {
    string(name: 'AWS_CRED_ID', defaultValue: 'jenkins-aws')
    string(name: 'DOCKER_HOST_', defaultValue: 'tcp://172.31.18.232:2375')
    string(name: 'EKS_CLUSTER_REGION', defaultValue: 'eu-north-1')
    string(name: 'EKS_CLUSTER_NAME', defaultValue: '')
  }
  stages {
    stage('Build App') {
      agent none
      options {
        timeout(time: 600, unit: 'SECONDS')
      }
      when {
        allOf {
          expression {
            env.BRANCH_NAME in ['main']
          }
          anyOf {
            changeset "src/main/**"
            triggeredBy 'UserIdCause'
          }
        }
      }
      stages {
        stage('nested'){
          agent {
            dockerContainer {
              image "${AGENT_IMAGE}"
            }
          }
          steps {
            sh 'mvn -B package'
            stash includes: '**/target/*.jar', name: 'package'
            archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true
          }
          post {
            always {
              junit '**/target/surefire-reports/*.xml'
            }
          }
        }
      }
    }
    stage('Build Image') {
      agent none
      options {
        timeout(time: 600, unit: 'SECONDS')
      }
      when {
        allOf {
          expression {
            env.BRANCH_NAME in ['main']
          }
          anyOf {
            changeset "src/main/**"
            triggeredBy 'UserIdCause'
          }
        }
      }
      stages {
        stage('nested'){
          agent {
            dockerContainer {
              image "${AGENT_IMAGE}"
            }
          }
          environment {
            DOCKER_HOST = "${DOCKER_HOST_}"
          }
          steps {
            withCredentials([usernamePassword(credentialsId: AWS_CRED_ID, usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
              unstash 'package'
              sh '''
              cp target/*.jar app.jar
              cp cicd/Dockerfile .
              export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
              $(aws sts assume-role \
              --role-arn $JENKINS_AWS_ROLE \
              --role-session-name JenkinsBuildImage \
              --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \
              --output text))
              aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
              docker buildx build -t $GIT_COMMIT .
              docker image tag $GIT_COMMIT $IMAGE_REGISTRY/$APP_NAME-$BRANCH_NAME:$GIT_COMMIT
              docker image push $IMAGE_REGISTRY/$APP_NAME-$BRANCH_NAME:$GIT_COMMIT
              docker manifest inspect $IMAGE_REGISTRY/$APP_NAME-$BRANCH_NAME:$GIT_COMMIT > manifest.json
              docker image rm $GIT_COMMIT $IMAGE_REGISTRY/$APP_NAME-$BRANCH_NAME:$GIT_COMMIT
              docker logout $IMAGE_REGISTRY
              '''
              archiveArtifacts artifacts: 'manifest.json', fingerprint: true
            }
          }
        }
      }
    }
    stage('Deploy') {
      agent none
      options {
        timeout(time: 600, unit: 'SECONDS')
      }
      when {
        allOf {
          expression {
            env.BRANCH_NAME in ['main', 'test']
          }
          anyOf {
            changeset "src/main/**"
            triggeredBy 'UserIdCause'
          }
        }
      }
      stages {
        stage('nested'){
          agent {
            dockerContainer {
              image "${AGENT_IMAGE}"
            }
          }
          steps {
            withCredentials([usernamePassword(credentialsId: AWS_CRED_ID, usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
              sh '''
              export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" \
              $(aws sts assume-role \
              --role-arn $JENKINS_AWS_ROLE \
              --role-session-name JenkinsDeploy \
              --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]" \
              --output text))
              aws eks update-kubeconfig --name ${EKS_CLUSTER_NAME} --region ${EKS_CLUSTER_REGION}
              helm upgrade \
                --create-namespace \
                --namespace ${APP_NAME}-${BRANCH_NAME} \
                --install ${APP_NAME}-${BRANCH_NAME} \
                --set branchName="${BRANCH_NAME}" \
                --set awsAccountId="${AWS_ACCOUNT_ID}" \
                --set awsRegion="${AWS_REGION}" \
                --set application.image="${APP_NAME}-${BRANCH_NAME}" \
                --set application.imageTag="${GIT_COMMIT}" helm/petclinic"
              delaySec=4
              healthCheckPassed=false
              hostname=$(kubectl get svc "${APP_NAME}-${BRANCH_NAME}" -n "${APP_NAME}-${BRANCH_NAME}" -o yaml | yq '.status.loadBalancer.ingress[0].hostname')
              port=$(kubectl get svc "${APP_NAME}-${BRANCH_NAME}" -n "${APP_NAME}-${BRANCH_NAME}" -o yaml | yq '.spec.ports[0].port')
              while [ "$healthCheckPassed" != true ]; do
                if curl --silent --fail "http://${hostname}:${port}/actuator/health" > /dev/null; then
                  healthCheckPassed=true
                  echo "Health check passed!"
                else
                  echo "Health check failed, retrying in ${delaySec} seconds..."
                  sleep "$delaySec"
                fi
              done
              '''
            }
          }
        }
      }
    }
  }
}
